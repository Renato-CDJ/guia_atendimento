<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roteiro de Atendimento - Operador</title>
  <link rel="stylesheet" href="roteiro.css" />
  <link rel="icon" type="image/png" href="img/operador-de-telemarketing.png">

  <!-- VariÃ¡veis e tÃ­tulo animado (mesmo comportamento do login) -->
  <style>
    :root{
      --accent-dark: #00c853;
      --accent2-dark: #00e676;
      --accent-light: #ff5722;
      --accent2-light: #ff9800;
    }
    .title {
  font-size: clamp(34px, 5vw, 40px);
  font-weight: 900;
  text-align: center;
  margin: 10px 0 20px;
  background: linear-gradient(90deg, var(--accent-dark, #00c853), var(--accent2-dark, #00e676));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: glow-dark 3s infinite ease-in-out;
}
body[data-theme="light"] .title {
  background: linear-gradient(90deg, var(--accent-light, #ff5722), var(--accent2-light, #ff9800));
  -webkit-background-clip: text;
  background-clip: text;
  animation: glow-light 3s infinite ease-in-out;
}

@keyframes glow-dark {
  0%,100% { filter: drop-shadow(0 0 6px rgba(0,200,83,.5)); }
  50% { filter: drop-shadow(0 0 18px rgba(0,200,83,.9)); }
}
@keyframes glow-light {
  0%,100% { filter: drop-shadow(0 0 6px rgba(255,87,34,.5)); }
  50% { filter: drop-shadow(0 0 18px rgba(255,87,34,.9)); }
}

/* Barra de pesquisa mais larga*/
header .toolbar #searchInput{
  flex: 1 1 600px;
  min-width: clamp(420px, 50vw, 380px);
}

</style>
</head>
<body data-role="operador">
  <div class="container">
    <!-- CabeÃ§alho -->
    <header>
      <div><h1 class="title">Roteiro de Atendimento</h1></div>
      <div class="toolbar">
        <input type="text" id="searchInput" class="select" placeholder="ğŸ” Pesquisar..." />
        <button id="btnToggleTheme" class="badge">ğŸŒ— Tema</button>
        <button id="btnLogout" class="badge">ğŸšª Sair</button>

      </div>
    </header>

    <!-- Barra de progresso -->
    <div class="progress">
      <div class="progressbar"><div id="bar"></div></div>
    </div>

    <!-- Alerta -->
    <div id="tabAlert" class="tab-alert">
      <div class="msg">
        <b><i>Caso a ligaÃ§Ã£o seja interrompida ou cliente desligou, verifique a tabulaÃ§Ã£o no Ã­cone (âœ”) abaixo</i></b> â¬‡ï¸
      </div>
      <span class="arrow"></span>
    </div>

    <!-- Fluxo -->
    <main id="flow"></main>

    <!-- BotÃµes globais -->
    <div id="globalActions" class="global-actions"></div>
  </div>

  <!-- Modal de TabulaÃ§Ã£o -->
  <div id="tabModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>TabulaÃ§Ã£o</h2>
      <p id="modalText"></p>
    </div>
  </div>

  <!-- Atalhos -->
  <div class="bottom-shortcuts">
    <a href="tabulacoes.html">ğŸ“‘ TabulaÃ§Ãµes</a>
    <a href="situacoes.html">ğŸ“ SituaÃ§Ãµes</a>
    <a href="canais.html">â˜ï¸ Canais</a>
    <button id="noteToggle">ğŸ“ Bloco de notas</button>
  </div>

  <!-- Painel de Notas -->
  <div id="notePanel">
    <div id="noteToolbar">
      <button onclick="formatNote('bold')"><b>B</b></button>
      <button onclick="formatNote('italic')"><i>I</i></button>
      <button onclick="formatNote('underline')"><u>U</u></button>
      <button onclick="formatNote('insertUnorderedList')">â€¢ Lista</button>
      <button id="noteClose">âœ•</button>
    </div>
    <div id="noteEditor" contenteditable="true"></div>
  </div>

  <!-- App -->
<script src="roteiro.js"></script>

<!-- Bloco de notas + status online -->
<script type="module">
  import { db } from "./firebase.js";
  import { doc, getDoc, setDoc, updateDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const noteToggle = document.getElementById("noteToggle");
  const notePanel  = document.getElementById("notePanel");
  const noteEditor = document.getElementById("noteEditor");
  const noteClose  = document.getElementById("noteClose");

  noteToggle.addEventListener("click", () => notePanel.classList.toggle("active"));
  noteClose?.addEventListener("click", () => notePanel.classList.remove("active"));

  window.formatNote = (cmd) => {
    document.execCommand(cmd, false, null);
    saveNotes();
  };

  const noteDocRef = doc(db, "anotacoes", "operador");

  async function saveNotes() {
    try {
      await setDoc(noteDocRef, {
        conteudo: noteEditor.innerHTML,
        atualizado: new Date().toISOString()
      });
      console.log("Nota salva no Firestore!");
    } catch (e) { console.error("Erro ao salvar nota:", e); }
  }

  async function loadNotes() {
    try {
      const snap = await getDoc(noteDocRef);
      if (snap.exists()) noteEditor.innerHTML = snap.data().conteudo || "";
    } catch (e) { console.error("Erro ao carregar nota:", e); }
  }

  noteEditor.addEventListener("input", saveNotes);
  loadNotes();

  // === STATUS ONLINE DO OPERADOR ===
  const operador = localStorage.getItem("operador");
  if (operador) {
    const statusRef = doc(db, "status_online", operador);

    // Marca como online
    setDoc(statusRef, {
      nome: operador,
      online: true,
      conectadoEm: serverTimestamp(),
      ultimoPing: serverTimestamp()
    }, { merge: true });

    // Atualiza "ultimoPing" a cada 30s
    setInterval(() => {
      updateDoc(statusRef, { ultimoPing: serverTimestamp(), online: true });
    }, 30000);

    // Ao fechar aba ou sair -> marca como offline
    window.addEventListener("beforeunload", async () => {
      await updateDoc(statusRef, { online: false, desconectadoEm: serverTimestamp() });
    });
  }
</script>

<script>
// === PROGRESSO baseado em botÃµes de FINALIZAR / VOLTAR AO INÃCIO ===
(function(){
  const bar = document.getElementById("bar");
  if(!bar) return;

  const setProgress = (p)=>{
    const pct = Math.max(0, Math.min(100, Math.round(p)));
    bar.style.width = pct + "%";
    bar.setAttribute("aria-valuenow", pct);
  };

  const actions = document.getElementById("globalActions");

  function isFinalizeElement(el){
    if(!el) return false;
    const t = (el.textContent || "").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    if (/\b(finalizar|finaliza|concluir|encerrar|tabular|fim)\b/.test(t)) return true;
    const id = (el.id || "").toLowerCase();
    if (/final/.test(id)) return true;
    if (el.dataset && (el.dataset.finalizar==='1' || el.dataset.action==='finalizar')) return true;
    return false;
  }

  function scanForFinalize(root){
    if(!root) return false;
    const candidates = root.querySelectorAll("button, a, [role='button']");
    for (const el of candidates){
      if (isFinalizeElement(el)) return true;
    }
    return false;
  }

  const observer = new MutationObserver(()=>{
    if (scanForFinalize(actions)) setProgress(100);
  });
  if(actions){
    observer.observe(actions, { childList: true, subtree: true });
    if (scanForFinalize(actions)) setProgress(100);
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button, a, [role='button']");
    if(!btn) return;
    const t = (btn.textContent || "").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    if (isFinalizeElement(btn)) {
      setProgress(100);
      return;
    }
    if (/\b(voltar.*inicio|inicio|comecar|recomecar|reiniciar)\b/.test(t) || btn.id === "btnInicio") {
      setProgress(0);
    }
  });
})();

window._progress = {
  set: (p)=>{
    const bar = document.getElementById("bar");
    if(bar){ bar.style.width = Math.max(0,Math.min(100,p)) + "%"; }
  },
  full: ()=> window._progress.set(100),
  reset: ()=> window._progress.set(0),
};
</script>

<script>
  const btnLogout = document.getElementById("btnLogout");
  btnLogout?.addEventListener("click", () => {
    localStorage.removeItem("operador"); 
    window.location.href = "login.html";
  });
</script>


</body>
</html>
