<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Criar Operador</title>
  <link rel="icon" type="image/png" href="img/operador-de-telemarketing.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f1113;
      color: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      margin: 0;
      gap: 30px;
      padding: 30px;
    }
    .box {
      background: rgba(0,0,0,0.7);
      padding: 30px;
      border-radius: 12px;
      width: 350px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,.5);
    }
    h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: #00e676;
    }
    input[type="text"], input[type="file"] {
      width: 90%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.3);
      background: rgba(0,0,0,.25);
      color: #fff;
      font-size: 15px;
    }
    button {
      width: 95%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, #00c853, #00e676);
      color: #06140b;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: transform .2s ease, filter .2s ease;
    }
    button:hover { transform: translateY(-2px); filter: brightness(1.1); }
    #msg {
      margin-top: 10px;
      font-size: 14px;
      white-space: pre-line;
    }

    /* Painel de Controle */
    .online-box {
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 12px;
      width: 420px;
      box-shadow: 0 6px 18px rgba(0,0,0,.5);
    }
    .online-box h3 {
      font-size: 18px;
      margin: 0 0 15px;
      color: #00e676;
    }
    .user {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      margin-bottom: 8px;
    }
    .user span {
      font-weight: 500;
    }
    .user-actions {
      display: flex;
      gap: 6px;
    }
    .user-actions button {
      border: none;
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 12px;
      cursor: pointer;
      color: #fff;
    }
    .user-actions button.edit { background: #2196f3; }
    .user-actions button.delete { background: #e53935; }
    .user-actions button.block { background: #ff9800; }
    .user-actions button.disconnect { background: #9c27b0; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Criar Operadores</h2>

    <!-- Cadastro individual -->
    <input type="text" id="opName" placeholder="Nome do operador" />
    <button id="btnAddOperator">Registrar Operador</button>

    <hr style="margin:20px 0; border:1px solid rgba(255,255,255,.2)">

    <!-- Upload em lote -->
    <label>Importar lista (.csv ou .xlsx):</label>
    <input type="file" id="fileInput" accept=".csv, .xlsx" />
    <button id="btnUpload">Importar Arquivo</button>

    <div id="msg"></div>
  </div>

  <!-- Painel de Controle -->
  <div class="online-box">
    <h3>ðŸ‘¥ Operadores Conectados (<span id="countOnline">0</span>)</h3>
    <div id="onlineList"></div>
    <hr style="margin:12px 0; border:1px solid rgba(255,255,255,.2)">
    <button id="btnExport">ðŸ“„ Exportar RelatÃ³rio</button>
  </div>

  <!-- Libs externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { app, db } from "./firebase.js";
    import { doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const msg = document.getElementById("msg");

    // === CADASTRO INDIVIDUAL ===
    document.getElementById("btnAddOperator").addEventListener("click", async () => {
      const nome = document.getElementById("opName").value.trim();
      if (!nome) {
        msg.textContent = "âš ï¸ Digite um nome.";
        return;
      }
      try {
        await setDoc(doc(db, "operadores", nome.toLowerCase()), {
          nome,
          criadoEm: new Date().toISOString()
        });
        msg.textContent = `âœ… Operador "${nome}" registrado com sucesso!`;
      } catch (e) {
        msg.textContent = "Erro: " + e.message;
      }
    });

    // === IMPORTAÃ‡ÃƒO CSV / XLSX ===
    document.getElementById("btnUpload").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        msg.textContent = "âš ï¸ Selecione um arquivo CSV ou XLSX.";
        return;
      }

      msg.textContent = "â³ Processando arquivo...";

      if (file.name.endsWith(".csv")) {
        Papa.parse(file, {
          header: false,
          complete: async (results) => {
            await salvarEmLote(results.data.flat().filter(n => n));
          }
        });
      } else if (file.name.endsWith(".xlsx")) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const nomes = XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat();
          await salvarEmLote(nomes.filter(n => n));
        };
        reader.readAsArrayBuffer(file);
      } else {
        msg.textContent = "âš ï¸ Formato nÃ£o suportado.";
      }
    });

    async function salvarEmLote(nomes) {
      let sucesso = 0, erros = 0;
      for (const nome of nomes) {
        const clean = String(nome).trim();
        if (!clean) continue;
        try {
          await setDoc(doc(db, "operadores", clean.toLowerCase()), {
            nome: clean,
            criadoEm: new Date().toISOString()
          });
          sucesso++;
        } catch (e) {
          erros++;
          console.error("Erro ao salvar:", clean, e);
        }
      }
      msg.textContent = `âœ… ${sucesso} operadores cadastrados.\nâš ï¸ ${erros} falhas.`;
    }

    // === PAINEL ONLINE EM TEMPO REAL ===
    const onlineList = document.getElementById("onlineList");
    const countOnline = document.getElementById("countOnline");
    let relatorio = [];

    onSnapshot(collection(db, "status_online"), (snapshot) => {
      onlineList.innerHTML = "";
      let count = 0;
      relatorio = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.online) count++;

        relatorio.push({
          nome: data.nome,
          conectadoEm: data.conectadoEm?.toDate?.() || "",
          desconectadoEm: data.desconectadoEm?.toDate?.() || ""
        });

        const div = document.createElement("div");
        div.className = "user";
        div.innerHTML = `
          <span>${data.nome} ${data.online ? "ðŸŸ¢" : "âšª"}</span>
          <div class="user-actions">
            <button class="edit">Editar</button>
            <button class="delete">Excluir</button>
            <button class="block">Bloquear</button>
            <button class="disconnect">Desconectar</button>
          </div>
        `;

        // AÃ§Ãµes
        div.querySelector(".edit").addEventListener("click", async () => {
          const novoNome = prompt("Novo nome para operador:", data.nome);
          if (novoNome) {
            await setDoc(doc(db, "operadores", novoNome.toLowerCase()), { nome: novoNome }, { merge: true });
          }
        });

        div.querySelector(".delete").addEventListener("click", async () => {
          if (confirm("Excluir operador " + data.nome + "?")) {
            await deleteDoc(doc(db, "operadores", data.nome.toLowerCase()));
            await deleteDoc(doc(db, "status_online", data.nome));
          }
        });

        div.querySelector(".block").addEventListener("click", async () => {
          await updateDoc(doc(db, "status_online", data.nome), { bloqueado: true });
          alert(data.nome + " foi bloqueado.");
        });

        div.querySelector(".disconnect").addEventListener("click", async () => {
          await updateDoc(doc(db, "status_online", data.nome), { online: false, desconectadoEm: new Date() });
        });

        onlineList.appendChild(div);
      });

      countOnline.textContent = count;
    });

    // Exportar relatÃ³rio em CSV
    document.getElementById("btnExport").addEventListener("click", () => {
      let csv = "Nome,Conectado em,Desconectado em\n";
      relatorio.forEach(r => {
        csv += `${r.nome},${r.conectadoEm},${r.desconectadoEm}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "relatorio-operadores.csv";
      a.click();
    });
  </script>
</body>
</html>
