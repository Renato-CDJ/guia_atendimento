<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Situações de Atendimento</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #0f1113;
      color: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #00c853; }
    .screen {
      background: #15181b;
      padding: 16px;
      border-radius: 12px;
      margin: 12px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
    }
    .title { font-size: 18px; font-weight: bold; margin-bottom: 6px; }
    .script { font-size: 15px; line-height: 1.5; margin-bottom: 10px; }
    .badge {
      background: #21272d;
      border: 1px solid #2a3138;
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      margin: 4px;
      font-size: 13px;
    }
    .badge:hover { background: #263039; }

    /* Painel ADM (padrão index.html) */
    .adm {
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 340px; max-width: 90vw;
      background: #15181b;
      border-left: 1px solid #20262c;
      box-shadow: -20px 0 40px rgba(0,0,0,.4);
      padding: 14px 14px 70px;
      transform: translateX(100%);
      transition: transform .28s ease;
      z-index: 1200;
      display: none;
    }
    .adm.open { transform: translateX(0); display: block; }
    .adm > header {
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .adm label {
      display:block; font-size:12px; color:#aab0b6; margin:10px 0 6px;
    }
    .adm input, .adm textarea {
      width:100%;
      border:1px solid #2a333b;
      background:#0f1113;
      color:#f5f7fa;
      border-radius:10px;
      padding:8px 10px;
      outline:none;
    }
    .adm textarea { min-height: 90px; resize: vertical; }
    .adm .actions {
      display:flex; gap:8px; margin-top:16px;
    }
    .adm button {
      flex:1;
      border:none;
      border-radius:10px;
      padding:10px;
      font-weight:700;
      cursor:pointer;
    }
    .adm .primary {
      background: linear-gradient(90deg, #00c853, #00e676);
      color:#06140b;
    }
    .adm .danger {
      background:#e53935;
      color:#fff;
    }
  </style>
</head>
<body>
  <h1>Situações de Atendimento</h1>
  <p>Lista de situações abaixo (público):</p>

  <!-- Lista de situações -->
  <main id="situacoesList"></main>

  <!-- Botão ADM -->
  <button id="btnToggleAdm" class="badge">⚙️ ADM</button>

  <!-- Painel ADM -->
  <aside class="adm" id="admPanel">
    <header>
      <div id="admTitle">Nova Situação</div>
      <button id="btnAdmClose" class="badge">✕</button>
    </header>

    <label for="fldTitulo">Título</label>
    <input type="text" id="fldTitulo" placeholder="Ex: Cliente recusa negociação">

    <label for="fldDescricao">Descrição</label>
    <textarea id="fldDescricao" placeholder="Digite aqui a descrição..."></textarea>

    <div class="actions">
      <button id="btnSave" class="primary">Salvar</button>
      <button id="btnDel" class="danger" style="display:none;">Excluir</button>
    </div>
  </aside>

  <!-- Firebase / Firestore -->
  <script type="module">
    import { db, auth } from "./firebase.js";
    import { 
      collection, addDoc, setDoc, deleteDoc, doc, 
      onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const list = document.getElementById("situacoesList");
    const btnToggleAdm = document.getElementById("btnToggleAdm");
    const admPanel = document.getElementById("admPanel");
    const fldTitulo = document.getElementById("fldTitulo");
    const fldDescricao = document.getElementById("fldDescricao");
    const btnSave = document.getElementById("btnSave");
    const btnDel = document.getElementById("btnDel");
    const admTitle = document.getElementById("admTitle");
    const btnAdmClose = document.getElementById("btnAdmClose");

    let isAdmin = false;
    let editId = null;

    // Controle de login ADM
    onAuthStateChanged(auth, (user) => {
      isAdmin = !!user;
      btnToggleAdm.style.display = isAdmin ? "" : "none";
    });

    // Abrir painel para NOVA situação
    btnToggleAdm.addEventListener("click", () => {
      if (!isAdmin) return alert("Somente administradores podem usar o painel.");
      editId = null;
      fldTitulo.value = "";
      fldDescricao.value = "";
      admTitle.textContent = "Nova Situação";
      btnDel.style.display = "none";
      admPanel.classList.add("open");
    });

    // Fechar painel
    btnAdmClose.addEventListener("click", () => {
      admPanel.classList.remove("open");
    });

    // Salvar (criar/editar)
    btnSave.addEventListener("click", async () => {
      if (!isAdmin) return;
      const titulo = fldTitulo.value.trim();
      const descricao = fldDescricao.value.trim();
      if (!titulo) return alert("Informe um título.");

      try {
        if (editId) {
          await setDoc(doc(db, "situacoes", editId), { titulo, descricao }, { merge: true });
        } else {
          await addDoc(collection(db, "situacoes"), { titulo, descricao });
        }
        admPanel.classList.remove("open");
      } catch (e) {
        console.error("Erro ao salvar:", e);
        alert("Erro ao salvar, veja o console.");
      }
    });

    // Excluir
    btnDel.addEventListener("click", async () => {
      if (!isAdmin || !editId) return;
      if (!confirm("Excluir esta situação?")) return;
      try {
        await deleteDoc(doc(db, "situacoes", editId));
        admPanel.classList.remove("open");
      } catch (e) {
        console.error("Erro ao excluir:", e);
        alert("Erro ao excluir, veja o console.");
      }
    });

    // Leitura em tempo real (público)
    const q = query(collection(db, "situacoes"), orderBy("titulo"));
    onSnapshot(q, (snap) => {
      list.innerHTML = "";
      snap.forEach(d => {
        const s = d.data();
        const card = document.createElement("section");
        card.className = "screen";
        card.innerHTML = `
          <div class="title">${s.titulo}</div>
          <div class="script">${s.descricao}</div>
          ${isAdmin ? `<button class="badge" data-edit="${d.id}">✏️ Editar</button>` : ""}
        `;
        list.appendChild(card);
      });

      // Ações de edição (somente ADM)
      if (isAdmin) {
        document.querySelectorAll("[data-edit]").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-edit");
            const item = snap.docs.find(doc => doc.id === id)?.data();
            if (!item) return;
            editId = id;
            fldTitulo.value = item.titulo;
            fldDescricao.value = item.descricao;
            admTitle.textContent = "Editar Situação";
            btnDel.style.display = "inline-block";
            admPanel.classList.add("open");
          });
        });
      }
    });
  </script>
</body>
</html>
