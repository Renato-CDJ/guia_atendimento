<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Situa√ß√µes</title>
  <style>
    :root{
      --bg:#0f1113; --panel:#15181b; --panel-2:#1b2024; --text:#f5f7fa; --muted:#aab0b6;
      --border:#22292f; --badge-bg:#21272d; --badge-border:#2a3138;
      --accent:#00c853; --accent-2:#00e676; --shadow:0 12px 34px rgba(0,0,0,.35);
    }
    body[data-theme="light"]{
      --bg:#fff; --panel:#fff; --panel-2:#f7f7f8; --text:#1b1f24; --muted:#666;
      --border:#e5e7eb; --badge-bg:#f3f4f6; --badge-border:#e5e7eb;
      --accent:#ff6d00; --accent-2:#ffa000; --shadow:0 8px 20px rgba(0,0,0,.08);
    }

    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; padding:20px; display:flex; justify-content:center;
    }
    .container{ width:100%; max-width:1000px }

    header{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:16px }
    header h1{ margin:0; font-size:22px; color:var(--accent) }
    .muted{ color:var(--muted); margin:0 }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
    .select,.badge{
      border:1px solid var(--badge-border); background:var(--panel-2); color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }

    /* ===== GRID ===== */
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:14px }
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:12px; padding:14px 18px;
      cursor:pointer; transition:background .25s ease, transform .2s ease;
      position:relative; overflow:hidden;
    }
    .card:hover{ background:var(--panel-2); transform:translateY(-2px) }

    .card h3{ margin:0 0 6px; font-size:18px; color:var(--accent) }
    .card .meta{ font-size:12px; color:var(--muted); margin-bottom:6px }
    .card p{ margin:0; font-size:14px; line-height:1.45; color:var(--text); max-height:60px; overflow:hidden; text-overflow:ellipsis }

    .item-actions{ position:absolute; top:10px; right:10px; display:flex; gap:6px; opacity:0; transition:opacity .25s }
    .card:hover .item-actions{ opacity:1 }
    .action-btn{ border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:16px; padding:4px; border-radius:6px }
    .action-btn:hover{ background:var(--badge-bg); color:var(--accent) }

    /* ===== MODAL ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center; z-index:2000; padding:20px;
    }
    .modal-backdrop.open{ display:flex }
    .modal{
      background:var(--panel); border-radius:20px; padding:28px 24px;
      max-width:900px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:var(--shadow);
      animation:fadeIn .25s ease;
    }
    .modal h2{ margin-top:0; font-size:24px; color:var(--accent) }
    .modal .meta{ margin:0 0 12px }
    .modal p{ margin:14px 0 0; line-height:1.75; font-size:16px; white-space:pre-wrap }
    .modal footer{ margin-top:18px; display:flex; gap:8px; justify-content:flex-end }
    .btn{ border:1px solid var(--badge-border); background:var(--badge-bg); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn.primary{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:#06140b }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(12px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)} }

    /* ===== PAINEL ADM ===== */
    .adm{
      position:fixed; top:0; right:0; bottom:0; width:340px; max-width:90vw;
      background:var(--panel); border-left:1px solid var(--border);
      box-shadow:-20px 0 40px rgba(0,0,0,.35);
      padding:14px 14px 70px; transform:translateX(100%); transition:transform .28s ease;
      z-index:2200; display:none;
    }
    .adm.open{ transform:translateX(0); display:block }
    .adm > header{ font-weight:700; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center }
    .adm input,.adm textarea,.adm select{
      width:100%; border:1px solid var(--badge-border); background:var(--panel-2); color:var(--text);
      border-radius:10px; padding:8px 10px; outline:none;
    }
    .adm textarea{ min-height:120px; resize:vertical }
    .adm-footer{ position:absolute; left:14px; right:14px; bottom:12px; display:flex; gap:8px }
    .btn-mini{ border:1px solid var(--badge-border); background:var(--badge-bg); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
    .btn-mini.primary{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:#06140b }
    .btn-mini.danger{ background:#2a1211; border-color:#542625; color:#ffdede }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Situa√ß√µes</h1>
        <p class="muted">Consulta de situa√ß√µes por campanha</p>
      </div>
      <div class="toolbar">
        <!-- üîπ filtro de categorias -->
        <select id="filterCategoria" class="select"></select>
        <input id="searchInput" class="select" type="text" placeholder="üîç Pesquisar..." />
        <button id="btnToggleTheme" class="badge">üåó Tema</button>
        <button id="btnToggleAdm" class="badge" style="display:none;">‚öôÔ∏è ADM</button>
        <button id="btnCategorias" class="badge" style="display:none;">üìÇ Categorias</button>
      </div>
    </header>

    <main id="situacoesList" class="grid"></main>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2 id="modalTitle"></h2>
      <div id="modalMeta" class="meta"></div>
      <p id="modalDesc"></p>
      <footer>
        <button id="btnEditFromModal" class="btn" style="display:none;">Editar</button>
        <button id="btnCloseModal" class="btn">Fechar</button>
      </footer>
    </div>
  </div>

  <!-- Painel ADM (Situa√ß√µes) -->
  <aside class="adm" id="admPanel">
    <header>
      <div id="admTitle">Nova Situa√ß√£o</div>
      <button id="btnAdmClose" class="btn">‚úï</button>
    </header>

    <label>T√≠tulo</label>
    <input type="text" id="fldTitulo" />

    <label style="margin-top:8px;">Descri√ß√£o</label>
    <textarea id="fldDescricao"></textarea>

    <label style="margin-top:8px;">Categoria</label>
    <select id="fldCategoria"></select>

    <div class="adm-footer">
      <button id="btnSave" class="btn-mini primary">Salvar</button>
      <button id="btnDel" class="btn-mini danger" style="display:none;">Excluir</button>
    </div>
  </aside>

  <!-- Painel ADM (Categorias) -->
  <aside class="adm" id="catPanel">
    <header>
      <div id="catTitle">Categorias</div>
      <button id="btnCatClose" class="btn">‚úï</button>
    </header>

    <label>Nome da categoria</label>
    <input type="text" id="fldCatNome" placeholder="Ex: Habitacional" />

    <div class="adm-footer">
      <button id="btnCatSave" class="btn-mini primary">Salvar</button>
      <button id="btnCatDel" class="btn-mini danger" style="display:none;">Excluir</button>
    </div>

    <div id="catList" style="margin-top:20px; display:flex; flex-direction:column; gap:6px;"></div>
  </aside>

  <script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, query, orderBy, onSnapshot, addDoc, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    /* refs */
    const list = document.getElementById("situacoesList");
    const searchInput = document.getElementById("searchInput");
    const filterCategoria = document.getElementById("filterCategoria");
    const btnToggleTheme = document.getElementById("btnToggleTheme");
    const btnToggleAdm = document.getElementById("btnToggleAdm");
    const btnCategorias = document.getElementById("btnCategorias");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalDesc = document.getElementById("modalDesc");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnEditFromModal = document.getElementById("btnEditFromModal");

    const admPanel = document.getElementById("admPanel");
    const admTitle = document.getElementById("admTitle");
    const btnAdmClose = document.getElementById("btnAdmClose");
    const btnSave = document.getElementById("btnSave");
    const btnDel = document.getElementById("btnDel");
    const fldTitulo = document.getElementById("fldTitulo");
    const fldDescricao = document.getElementById("fldDescricao");
    const fldCategoria = document.getElementById("fldCategoria");

    const catPanel = document.getElementById("catPanel");
    const btnCatClose = document.getElementById("btnCatClose");
    const btnCatSave = document.getElementById("btnCatSave");
    const btnCatDel = document.getElementById("btnCatDel");
    const fldCatNome = document.getElementById("fldCatNome");
    const catList = document.getElementById("catList");

    /* state */
    let cacheDocs = [];
    let cacheCats = [];
    let isAdmin = false;
    let editId = null;
    let catEditId = null;
    let modalDocId = null;
    let modalDocData = null;

    /* auth */
    onAuthStateChanged(auth, user=>{
      isAdmin = !!user;
      btnToggleAdm.style.display = isAdmin ? "" : "none";
      btnCategorias.style.display = isAdmin ? "" : "none";
      btnEditFromModal.style.display = isAdmin ? "" : "none";
    });

    /* categorias firestore */
    const qCats = query(collection(db,"categorias"), orderBy("nome"));
    onSnapshot(qCats,(snap)=>{
      cacheCats = snap.docs;
      renderCategoriasSelect();
      renderCategoriasList();
    });

    function renderCategoriasSelect(){
      // filtro
      filterCategoria.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "todas";
      optAll.textContent = "Todas as campanhas";
      filterCategoria.appendChild(optAll);

      // selects
      fldCategoria.innerHTML = "";
      cacheCats.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c.id;
        opt.textContent=c.data().nome;
        fldCategoria.appendChild(opt);

        const opt2=document.createElement("option");
        opt2.value=c.id;
        opt2.textContent=c.data().nome;
        filterCategoria.appendChild(opt2);
      });
      filterCategoria.value="todas";
    }

    function renderCategoriasList(){
      catList.innerHTML = "";
      cacheCats.forEach(c=>{
        const div=document.createElement("div");
        div.style.display="flex";
        div.style.justifyContent="space-between";
        div.style.alignItems="center";
        div.style.background="var(--panel-2)";
        div.style.padding="6px 10px";
        div.style.borderRadius="8px";
        div.innerHTML=`<span>${c.data().nome}</span>
          <div>
            <button data-edit="${c.id}" class="btn-mini">‚úèÔ∏è</button>
            <button data-del="${c.id}" class="btn-mini danger">üóëÔ∏è</button>
          </div>`;
        catList.appendChild(div);
      });

      catList.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.dataset.edit;
          const data=cacheCats.find(c=>c.id===id)?.data();
          if(!data) return;
          catEditId=id;
          fldCatNome.value=data.nome;
          btnCatDel.style.display="";
          catPanel.classList.add("open");
        };
      });
      catList.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick=async()=>{
          const id=btn.dataset.del;
          if(confirm("Excluir esta categoria?")){
            await deleteDoc(doc(db,"categorias",id));
          }
        };
      });
    }

    btnCategorias.addEventListener("click",()=>{
      fldCatNome.value="";
      catEditId=null;
      btnCatDel.style.display="none";
      catPanel.classList.add("open");
    });
    btnCatClose.addEventListener("click",()=>catPanel.classList.remove("open"));
    btnCatSave.addEventListener("click",async()=>{
      const nome=fldCatNome.value.trim();
      if(!nome) return alert("Informe um nome.");
      if(catEditId){
        await setDoc(doc(db,"categorias",catEditId),{nome},{merge:true});
      }else{
        await addDoc(collection(db,"categorias"),{nome});
      }
      catPanel.classList.remove("open");
    });
    btnCatDel.addEventListener("click",async()=>{
      if(!catEditId) return;
      if(confirm("Excluir esta categoria?")){
        await deleteDoc(doc(db,"categorias",catEditId));
        catPanel.classList.remove("open");
      }
    });

    /* situa√ß√µes firestore */
    const q = query(collection(db,"situacoes"), orderBy("titulo"));
    onSnapshot(q,(snap)=>{
      cacheDocs = snap.docs;
      render();
    });

    /* render */
    function render(){
      const term = searchInput.value.toLowerCase();
      const filtroCat = filterCategoria.value;

      const docs = cacheDocs.filter(d=>{
        const t=d.data();
        const matchSearch = (t.titulo||"").toLowerCase().includes(term) || (t.descricao||"").toLowerCase().includes(term);
        const matchCategoria = (filtroCat==="todas") || (t.categoria === filtroCat);
        return matchSearch && matchCategoria;
      });

      list.innerHTML = "";
      docs.forEach(d=>{
        const t = d.data();
        const cat = cacheCats.find(c=>c.id===t.categoria)?.data()?.nome || "Sem categoria";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${t.titulo || "(sem t√≠tulo)"}</h3>
          <div class="meta">Categoria: ${cat}</div>
          <p>${t.descricao || ""}</p>
          ${isAdmin ? `
            <div class="item-actions">
              <button class="action-btn" title="Editar">‚úèÔ∏è</button>
              <button class="action-btn" title="Excluir">üóëÔ∏è</button>
            </div>` : ""}
        `;

        card.addEventListener("click", e=>{
          if(e.target.closest(".action-btn")) return;
          openModal(d.id,t,cat);
        });

        if(isAdmin){
          const [btnEdit, btnDelBtn] = card.querySelectorAll(".action-btn");
          btnEdit.addEventListener("click", e=>{
            e.stopPropagation();
            openAdmForEdit(d.id,t);
          });
          btnDelBtn.addEventListener("click", async e=>{
            e.stopPropagation();
            if(confirm("Excluir esta situa√ß√£o?")){
              await deleteDoc(doc(db,"situacoes",d.id));
            }
          });
        }

        list.appendChild(card);
      });
    }

    /* modal */
    function openModal(id,data,catNome){
      modalDocId=id;
      modalDocData=data;
      modalTitle.textContent = data.titulo || "(sem t√≠tulo)";
      modalDesc.textContent = data.descricao || "";
      modalMeta.textContent = "Categoria: " + (catNome || "Sem categoria");
      modalBackdrop.classList.add("open");
    }
    btnCloseModal.addEventListener("click", ()=> modalBackdrop.classList.remove("open"));
    modalBackdrop.addEventListener("click", e=>{
      if(e.target===modalBackdrop) modalBackdrop.classList.remove("open");
    });
    btnEditFromModal.addEventListener("click", ()=>{
      if(!isAdmin||!modalDocId) return;
      openAdmForEdit(modalDocId,modalDocData);
      modalBackdrop.classList.remove("open");
    });

    /* ADM Situa√ß√µes */
    btnToggleAdm.addEventListener("click", ()=>{
      if(!isAdmin) return alert("Somente administradores podem usar o painel.");
      openAdmForNew();
    });
    btnAdmClose.addEventListener("click", ()=> admPanel.classList.remove("open"));

    function openAdmForNew(){
      editId=null;
      admTitle.textContent="Nova Situa√ß√£o";
      fldTitulo.value="";
      fldDescricao.value="";
      fldCategoria.value=cacheCats[0]?.id||"";
      btnDel.style.display="none";
      admPanel.classList.add("open");
    }
    function openAdmForEdit(id,data){
      editId=id;
      admTitle.textContent="Editar Situa√ß√£o";
      fldTitulo.value=data.titulo||"";
      fldDescricao.value=data.descricao||"";
      fldCategoria.value=data.categoria||"";
      btnDel.style.display="";
      admPanel.classList.add("open");
    }

    btnSave.addEventListener("click", async()=>{
      if(!isAdmin) return;
      const titulo=fldTitulo.value.trim();
      const descricao=fldDescricao.value.trim();
      const categoria=fldCategoria.value;
      if(!titulo) return alert("Informe um t√≠tulo.");
      try{
        if(editId){
          await setDoc(doc(db,"situacoes",editId),{titulo,descricao,categoria},{merge:true});
        }else{
          await addDoc(collection(db,"situacoes"),{titulo,descricao,categoria});
        }
        admPanel.classList.remove("open");
      }catch(e){ console.error(e); alert("Erro ao salvar."); }
    });

    btnDel.addEventListener("click", async()=>{
      if(!isAdmin||!editId) return;
      if(!confirm("Excluir esta situa√ß√£o?")) return;
      try{
        await deleteDoc(doc(db,"situacoes",editId));
        admPanel.classList.remove("open");
      }catch(e){ console.error(e); alert("Erro ao excluir."); }
    });

    /* tema */
    (function(){
      const stored=localStorage.getItem("theme");
      if(stored) document.body.setAttribute("data-theme",stored);
      else if(window.matchMedia("(prefers-color-scheme: light)").matches)
        document.body.setAttribute("data-theme","light");
      else document.body.setAttribute("data-theme","dark");

      btnToggleTheme.addEventListener("click",()=>{
        const cur=document.body.getAttribute("data-theme");
        const next=cur==="light"?"dark":"light";
        document.body.setAttribute("data-theme",next);
        localStorage.setItem("theme",next);
      });
    })();

    /* search + filtro */
    searchInput.addEventListener("input", render);
    filterCategoria.addEventListener("change", render);
  </script>
</body>
</html>
